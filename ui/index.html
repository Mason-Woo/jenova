<html>
    <head>
        <link rel="stylesheet" type="text/css" href="static/style.css">
    </head>
    <body>
        <h1>Bot Interface</h1>
        <h2>Version 0.1</h2>
        <hr/>
        <p>
            Type something or click the speak icon
            <button id="audio" onclick="add_command('audio');startDictation()">Speak</button>
        </p>
        <p>
            <div>
                <select id="lang" onchange="handleLanguageChange(event)">
                    <option value="en-US">English US</option>
                    <option value="ja-JP">Japanese</option>
                </select>
            </div>
        </p>
        <hr/>

        <p>
            <ul id="response" class="shell-body">
            </ul>
        </p>

        <script src="https://code.jquery.com/jquery-1.12.4.min.js"
                integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
                crossorigin="anonymous"></script>

        <script type="text/javascript">
            var SERVER_URL = 'http://localhost:8080/msg';
            var LANG = "en-US";
            var DATA_NANE = "default";
            var ALLOW_TYPING = true;

            var COMMAND_HELPS = {
                clear: 'Clear the console interface',
                say: 'Say a text to the bot server',
                train: 'Train the bot server',
                audio: 'Start dictation',
                raw: 'Send a raw command to the bot server',
                help: 'Print help'
            }

            var BOT_COMMANDS = {

                clear: function() {
                    $('#response').text('');
                    add_command('');
                },

                say: function(text) {
                    call_service(text);
                },

                raw: function(text) {
                    call_raw(text);
                },

                help: function(text) {
                    for(var command in COMMAND_HELPS) {
                        add_response(command + ': ' + COMMAND_HELPS[command], true);
                    }
                    add_command('');
                },

                audio: function(text) {
                    startDictation();
                },

                train: function(text) {
                    throw new Error('Unsupported Operation');
                }
            }

            function handleLanguageChange(event) {
                LANG = $('#lang').val();
                if (LANG == 'en-US')
                    DATA_NANE = 'default';
                else if (LANG == 'ja-JP')
                    DATA_NANE = 'japanese';
            }

            function startDictation() {
                $('#audio').prop('disabled', true);
                $('#audio').html('Speak now...');
                var recognition = new webkitSpeechRecognition();

                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.lang = LANG;
                recognition.start();

                recognition.onresult = function(e) {
                    $('#audio').prop('disabled', false);
                    $('#audio').html('Speak');
                    transcript = e.results[0][0].transcript;
                    recognition.stop();
                    add_command(transcript);
                    call_service(transcript);
                };

                recognition.onerror = function(e) {
                    $('#audio').prop('disabled', false);
                    $('#audio').html('Speak');
                    recognition.stop();
                    add_error('Audio failed: ' + e.error);
                }                
            }

            function call_service(text) {
                call_raw(JSON.stringify({
                    "name": "test",
                    "args": {
                        "data_name": DATA_NANE,
                        "text": text
                    }
                }));
            }

            function call_raw(text) {
                ALLOW_TYPING = false;
                $.post(SERVER_URL, text, function(res) {
                    ALLOW_TYPING = true;
                    if (res.status == 1) {
                        add_error(res.msg);
                    } else {
                        add_response(res.msg);
                    }
                }).fail(function(xhr, status, err) {
                    ALLOW_TYPING = true;
                    if (xhr.readyState == 0) {
                        add_error('Cannot connect to server');
                    } else {
                        add_error('Error from server: ' + err);
                    }
                });
            }

            function add_command(text) {
                $('#response').append('<li class="command">' + text + '</li>');
            }

            function add_response(text, skip_next_command) {
                $('#response').append('<li class="resp">' + text + '</li>');
                if (!skip_next_command) {
                    add_command('');
                }
                $('#response').scrollTop($('#response')[0].scrollHeight);
            }

            function add_error(err) {
                $('#response').append('<li class="error resp">' + err + '</li>');
                add_command('');
            }

            function run_command(text) {
                commands = text.split(' ');
                command = commands[0];
                if (command == '') {
                    return;
                }
                if (BOT_COMMANDS[command] == undefined) {
                    add_error(command + ': command not found. Type help for available commands.')
                    return;
                }
                commands.splice(0, 1);
                try {
                    BOT_COMMANDS[command](commands.join(' '));
                } catch(ex) {
                    add_error('Uncaught Exception: ' + ex);
                }
            }

            document.addEventListener('keydown', function(e) {
                if (!ALLOW_TYPING)
                    return;
                element = $('#response li:last');
                if (e.keyCode == 13) {
                    if (element.length == 0 || !element.hasClass('command'))
                        return;
                    text = element.text();
                    run_command(text);
                    return;
                }
                if (e.keyCode == 8) {
                    if (element.length == 0 || !element.hasClass('command'))
                        return;
                    text = element.text();
                    element.text(text.substr(0, text.length - 1))
                    return;
                }
                if ((e.keyCode != 32 && e.keyCode <= 40) || e.keyCode == 91)
                    return;
                if (e.keyCode >= 112 && e.keyCode <= 123)
                    return;
                if (e.ctrlKey || e.altKey || e.metaKey)
                    return;
                if (element.length == 0 || !element.hasClass('command')) {
                    add_command("");
                    element = $('#response li:last');
                }
                element.append(e.key);
            });

            run_command("help");
        </script>
    </body>
</html>