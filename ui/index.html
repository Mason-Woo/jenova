<html>
    <head>
        <link rel="stylesheet" type="text/css" href="static/style.css">
    </head>
    <body>
        <h1>Bot Interface</h1>
        <hr/>
        <p>
            Type something or click the speak icon
            <button id="audio" onclick="add_command('audio');startDictation()">Speak</button>
        </p>
        <p>
            <div>
                <select id="lang" onchange="handleLanguageChange(event)">
                    <option value="default">Default (English US)</option>
                    <option value="japanese">Japanese (Japanese)</option>
                    <option value="test">Test (English US)</option>
                </select>
            </div>
        </p>
        <hr/>

        <p>
            <ul id="response" class="shell-body theme-light">
            </ul>
        </p>


        <p>
            <input type="file" onchange="imageChange(event)" />
            <div id="preview"></div>
        </p>
    
        <button onclick="run_streamer()">start streamer</button>
        <button onclick="toggle_detection()">toggle detection</button>
        <div id="streamer">
            <div id="streamer_image"></div>
            <div id="streamer_box"></div>
        </div>

        <script src="https://code.jquery.com/jquery-1.12.4.min.js"
                integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
                crossorigin="anonymous"></script>

        <script src="static/bot.js"></script>

        <script>
            function imageChange(e) {
                var file = e.target.files[0];

                elPreview = document.getElementById("preview");
                var reader = new FileReader();
                reader.addEventListener("load", function () {
                    var image  = new Image();
        
                    image.addEventListener("load", function () {
                        $(elPreview).html('')
                        var imageInfo = file.name +' '+
                        image.width +'x'+
                        image.height +' '+
                        file.type +' '+
                        Math.round(file.size/1024) +'KB';

                        // Show image and info
                        elPreview.appendChild( this );
                        elPreview.insertAdjacentHTML("beforeend", imageInfo +'<br>');
                    });
                    image.src = reader.result;

                    var base64 = reader.result.substring('data:image/jpeg;base64,'.length);
                    detect_object(base64, function(result) {
                        var detection_results = result.msg.detections;
                        var boxes = build_box_html(detection_results);
                        $(elPreview).append(boxes);
                    }, function(err) {
                        console.log(err);
                    });
                });

                reader.readAsDataURL(file);
            }

            function build_box_html(detection_results) {
                if (detection_results.length == 0)
                    return '';
                return detection_results.map(result => {
                    result.boxes.forEach(box => box.class = result.class);
                    return result.boxes;
                })
                .reduce((a, b) => a.concat(b))
                .map(box => ({
                    'class': box.class,
                    'coord': {
                        'top': box.coord[1],
                        'left': box.coord[0],
                        'width': box.coord[2] - box.coord[0],
                        'height': box.coord[3] - box.coord[1]
                    },
                    'score': box.score
                })).map(box => map_box_html(box));
            }

            function map_box_html(box) {
                return '<div class="detection-box"  style="top: '+box.coord.top+'px; left: '+box.coord.left+'px; width: '+box.coord.width+'px; height: '+box.coord.height+'px"><div class="detection-class">'+box.class+' ('+Math.round(box.score * 100)+'%)'+'</div></div>';
            }

        </script>

        <script type="text/javascript">
            SERVER_URL = 'http://localhost:8080/msg';
            window.VISION_URL = 'http://localhost:8082/msg';
            window.LANG = "en-US";
            window.DATA_NANE = "default";
            window.BOT_VERSION = "0.1";
            window.ENABLE_TTS = false;
            window.STREAM_URL = 'http://localhost:8080/?action=snapshot';
            window.DETECTION_DELAY = 450;
            window.DETECTION_ENABLED = true;
            
            function handleLanguageChange(event) {
                DATA_NANE = $('#lang').val();
                if (DATA_NANE == 'default')
                    LANG = 'en-US';
                else if (DATA_NANE == 'test')
                    LANG == 'en-US';
                else if (DATA_NANE == 'japanese')
                    LANG == 'ja-JP';
            }

            add_response("Bot Interface - v" + BOT_VERSION, true);
            add_response("Type <b>help</b> for all available commands");

            var streamerBox = document.getElementById('streamer_box');
            var streamerImage = document.getElementById('streamer_image');

            var tick = Date.now();

            function toggle_detection() {
                DETECTION_ENABLED = !DETECTION_ENABLED;
                if (!DETECTION_ENABLED)
                    $(streamerBox).html('');
            }

            function run_streamer() {
                toDataURL(STREAM_URL, function(dataUrl) {
                    var image  = new Image();
            
                    image.addEventListener("load", function () {
                        $(streamerImage).html('');
                        streamerImage.appendChild( this );
                        run_streamer();
                    });
                    image.src = dataUrl;

                    var now = Date.now();
                    if (now - tick < window.DETECTION_DELAY || !DETECTION_ENABLED) {
                        return;
                    }
                    tick = now;
                    var base64 = dataUrl.substring('data:image/jpeg;base64,'.length);
                    detect_object(base64, function(result) {
                        if (!DETECTION_ENABLED)
                            return;
                        var detection_results = result.msg.detections;
                        var boxes = build_box_html(detection_results);
                        $(streamerBox).html(boxes);
                    }, function(err) {
                        console.log(err);
                    });
                });
            }

            function toDataURL(url, callback) {
                var xhr = new XMLHttpRequest();
                xhr.onload = function() {
                    var reader = new FileReader();
                    reader.onloadend = function() {
                    callback(reader.result);
                    }
                    reader.readAsDataURL(xhr.response);
                };
                xhr.open('GET', url);
                xhr.responseType = 'blob';
                xhr.send();
            }
        </script>
    </body>
</html>